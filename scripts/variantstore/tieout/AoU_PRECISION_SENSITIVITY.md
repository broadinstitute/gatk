# Generating Callset Precision and Sensitivity Values

## Prerequisites
Complete (at least) through the training step (`GvsCreateFilterSet`) of the [GVS pipeline](../AOU_DELIVERABLES.md) with all the samples (control and non-control).  Then run the callset extract step with a view of the sample-mapping table that's controls-only but with the training (i.e. "filter_set") from all the samples.

1. Use the GvsCalculatePrecisionAndSensitivity wdl to calculate the precision and sensitivity.

The wdl takes several inputs:

**input_vcfs** - A collection of VCFS - generated by `GvsExtractCallSet`. These need not be subsetted down to the chromosome.

```
[ "aou_callset_1K_223.vcf.gz", \
  "aou_callset_1K_224.vcf.gz", \
  "aou_callset_1K_225.vcf.gz", \
  "aou_callset_1K_226.vcf.gz", \
  "aou_callset_1K_227.vcf.gz", \
  "aou_callset_1K_228.vcf.gz", \
  "aou_callset_1K_229.vcf.gz"
```

**output_basename** - The base name for the output files generated by the pipeline.

**chromosome** - The chromosome on which to run the analysis of Precision and Sensitivity. The default value for this is `chr20`. If it is set to `all` then the analysis will be run across *all* chromosomes.

**sample_names** - A list of the sample names that are controls and that will be used for the analysis. For every element on the list of sample names there must be a corresponding element on the list of `truth_vcfs`, `truth_vcf_indices`, and `truth_beds`.

```
[ "NA12878", \
  "NA24385"
```
**truth_vcfs** - A list of the VCFs that contain the truth data used for analyzing the samples in `sample_names`.

```
[ "gs://broad-gotc-test-storage/gvs/truth/HG001_GRCh38_GIAB_highconf_CG-IllFB-IllGATKHC-Ion-10X-SOLID_CHROM1-X_v.3.3.2_highconf_PGandRTGphasetransfer.vcf.gz", \
  "gs://broad-gotc-test-storage/gvs/truth/HG002_GRCh38_1_22_v4.2.1_benchmark.vcf.gz"
```
**truth_vcf_indices** - A list of the VCF indices for the truth data VCFs supplied above.

```
[ "gs://broad-gotc-test-storage/gvs/truth/HG001_GRCh38_GIAB_highconf_CG-IllFB-IllGATKHC-Ion-10X-SOLID_CHROM1-X_v.3.3.2_highconf_PGandRTGphasetransfer.vcf.gz.tbi", \
  "gs://broad-gotc-test-storage/gvs/truth/HG002_GRCh38_1_22_v4.2.1_benchmark.vcf.gz.tbi"
```

**truth_beds** - A list of the bed files for the truth data used for analyzing the samples in `sample_names`.

```
[ "gs://broad-gotc-test-storage/gvs/truth/HG001.gvs.evaluation.bed", \
  "gs://broad-gotc-test-storage/gvs/truth/HG002.gvs.evaluation.bed"
```

**ref_fasta** - The cloud path for the reference fasta sequence.


## Appendix A: View ROCs
To view ROC curves for the data you will need to set up rtg-tools locally, using the following steps (typically you need do this only once):

1. Use `conda` to create a fresh environment to add these new tools to it:
 ```
 conda create --name gvs python=3.8
 conda activate gvs
 conda install -c bioconda rtg-tools
```
The base files needed to generate the ROC curves are among the outputs of the `GvsCalculatePrecisionAndSensitivity` wdl

You can use wildcards to pull in multiple datasets into the graphical viewer. For example
```
rtg roc NA12878_*_roc*/snp_roc.tsv.gz 
rtg roc NA12878_*_roc*/indel_roc.tsv.gz 
```
## Appendix B: Control Samples

"Truth" versions of control samples for this analysis are stored in:
```
gs://broad-dsp-spec-ops/gvs/truth/*
```

If you are missing any follow these steps there to add and prepare them to the above location

"Truth" versions of control samples are from the [Genome in a Bottle Consortium (GIAB)](https://www.nist.gov/programs-projects/genome-bottle) and [releases of their data can be found here](https://ftp-trace.ncbi.nlm.nih.gov/giab/ftp/release/) organized by source.
1. Download the `.bed`, `.vcf` and index files associated with the control sample.
2. Convert the calling region GVS is using to BED format
```
gsutil cp gs://gcp-public-data--broad-references/hg38/v0/wgs_calling_regions.hg38.noCentromeres.noTelomeres.interval_list .
gatk IntervalListToBed -I wgs_calling_regions.hg38.noCentromeres.noTelomeres.interval_list -O wgs_calling_regions.hg38.noCentromeres.noTelomeres.bed
rm wgs_calling_regions.hg38.noCentromeres.noTelomeres.interval_list
```
3. Then intersect with each of the truth datasets (this example is for HG-001):
```
bedtools intersect -a wgs_calling_regions.hg38.noCentromeres.noTelomeres.bed -b HG001_GRCh38_GIAB_highconf_CG-IllFB-IllGATKHC-Ion-10X-SOLID_CHROM1-X_v.3.3.2_highconf_nosomaticdel_noCENorHET7.bed > HG001.gvs.evaluation.bed
bedtools intersect -a wgs_calling_regions.hg38.noCentromeres.noTelomeres.bed -b HG002_GRCh38_1_22_v4.2.1_benchmark_noinconsistent.bed > HG002.gvs.evaluation.bed
bedtools intersect -a wgs_calling_regions.hg38.noCentromeres.noTelomeres.bed -b HG003_GRCh38_1_22_v4.2.1_benchmark_noinconsistent.bed > HG003.gvs.evaluation.bed
bedtools intersect -a wgs_calling_regions.hg38.noCentromeres.noTelomeres.bed -b CHM.full.38.bed.gz > CHM.gvs.evaluation.bed
```
4. Copy the GIAB data and the new `evaluation.bed` file to the `gs://broad-dsp-spec-ops/gvs/truth/` directory so the files will be available for future callsets.
